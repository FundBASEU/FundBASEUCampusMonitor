<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FundBASEU Live Tracker</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body{
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(135deg,#667eea,#764ba2);
  margin:0;
  padding:15px;
  color:white;
}
h1{
  text-align:center;
  font-size:20px;
  margin-bottom:5px;
}
.live{
  text-align:center;
  font-size:14px;
  margin-bottom:15px;
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:12px;
}
.card{
  background:white;
  color:#333;
  padding:14px;
  border-radius:14px;
  box-shadow:0 4px 18px rgba(0,0,0,.25);
  cursor:pointer;
}
.card h3{
  margin:0 0 6px 0;
  font-size:15px;
}
.status{
  font-weight:bold;
  margin-top:6px;
}
.small{
  font-size:11px;
  margin-top:4px;
}
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  justify-content:center;
  align-items:center;
  padding:15px;
}
.modal-content{
  background:white;
  color:#333;
  width:100%;
  max-width:400px;
  border-radius:14px;
  padding:18px;
  position:relative;
}
.close{
  position:absolute;
  top:10px;
  right:12px;
  font-size:18px;
  cursor:pointer;
}
button{
  width:100%;
  padding:12px;
  margin-top:8px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
}
.refresh{
  position:fixed;
  bottom:15px;
  right:15px;
  background:#3b82f6;
  color:white;
  border-radius:30px;
  padding:10px 16px;
  font-size:13px;
}
</style>
</head>
<body>

<h1>üéì FundBASEU Live Tracker</h1>
<div class="live">üë• Live Users: <span id="liveCount">0</span></div>
<button class="refresh" onclick="location.reload()">Refresh Live üîÑ</button>

<div class="grid">

<div class="card" onclick="openMess()">
<h3>üçΩ Mess</h3>
<div id="messMeal" class="status"></div>
<div id="messMenu" class="small"></div>
<div id="messStatus" class="small"></div>
<div id="messVotes" class="small"></div>
</div>

<div class="card" onclick="openGym()">
<h3>üèãÔ∏è Gym Crowd</h3>
<div id="gymStatus" class="status"></div>
</div>

<div class="card" onclick="openSimple('nescafe')">
<h3>‚òï Nescaf√©</h3>
<div id="nescafeStatus" class="status"></div>
</div>

<div class="card" onclick="openSimple('nandini')">
<h3>ü•õ Nandini</h3>
<div id="nandiniStatus" class="status"></div>
</div>

<div class="card" onclick="openBadminton()">
<h3>üè∏ Badminton Courts</h3>
<div id="badmintonStatus" class="status"></div>
<div id="badmintonVotes" class="small"></div>
</div>

</div>

<div class="modal" id="modal">
<div class="modal-content" id="modalContent">
<span class="close" onclick="closeModal()">‚úï</span>
</div>
</div>

<script>

// Firebase Config
firebase.initializeApp({
apiKey:"AIzaSyBeVAkgLuLzq6uYo6M5begEMi_jwi-nAoU",
authDomain:"fundbaseu-tracker.firebaseapp.com",
databaseURL:"https://fundbaseu-tracker-default-rtdb.firebaseio.com",
projectId:"fundbaseu-tracker"
});
var db = firebase.database();

// Presence
var p = db.ref("presence").push();
p.set(true);
p.onDisconnect().remove();
db.ref("presence").on("value", s=>{
  document.getElementById("liveCount").innerText=s.numChildren();
});

// Device ID
var deviceId = localStorage.getItem("deviceId");
if(!deviceId){
  deviceId="dev_"+Math.random().toString(36).substr(2,9);
  localStorage.setItem("deviceId",deviceId);
}

const MESS_THRESHOLD=3;
const BADMINTON_THRESHOLD=2;
const EXPIRE=10*60*1000;

// ---------- TIME + WEEK ENGINE ----------

function getCurrentMeal(){
  const now=new Date();
  const h=now.getHours();
  const m=now.getMinutes();
  const time=h*60+m;

  if(time>=450 && time<=540) return "Breakfast";
  if(time>=750 && time<=840) return "Lunch";
  if(time>=1020 && time<=1080) return "Snacks";
  if(time>=1170 && time<=1260) return "Dinner";

  if(time<450) return "Breakfast";
  if(time<750) return "Lunch";
  if(time<1020) return "Snacks";
  if(time<1170) return "Dinner";
  return "Breakfast";
}

function isEvenWeek(){
  const now=new Date();
  const oneJan=new Date(now.getFullYear(),0,1);
  const week=Math.ceil((((now-oneJan)/86400000)+oneJan.getDay()+1)/7);
  return week%2===0;
}

// Example simplified menu (can expand)
const menu={
Breakfast:{
odd:"Idly + Vada + Sambar + Chutney",
even:"Millets Khichdi + Idly + Vada + Sambar"
},
Lunch:"Chapathi + White Rice + Dal + Veg + Curd",
Snacks:"Evening Snack + Tea",
Dinner:"Chapathi + Rice + Dal + Veg"
};

function updateMessTile(){
  const meal=getCurrentMeal();
  const even=isEvenWeek();
  document.getElementById("messMeal").innerText=meal;
  if(meal==="Breakfast"){
    document.getElementById("messMenu").innerText=even?menu.Breakfast.even:menu.Breakfast.odd;
  }else{
    document.getElementById("messMenu").innerText=menu[meal];
  }
}

updateMessTile();

// ---------- MESS VOTING ----------

function openMess(){
  const meal=getCurrentMeal();
  const even=isEvenWeek();
  let menuText=(meal==="Breakfast")?(even?menu.Breakfast.even:menu.Breakfast.odd):menu[meal];

  document.getElementById("modalContent").innerHTML=
  "<span class='close' onclick='closeModal()'>‚úï</span>"+
  "<h3>"+meal+"</h3>"+
  "<p>"+menuText+"</p>"+
  "<button onclick=\"voteMess('Food Available')\">Food Available</button>"+
  "<button onclick=\"voteMess('Food Not Available')\">Food Not Available</button>";

  document.getElementById("modal").style.display="flex";
}

function voteMess(value){
  const voteRef=db.ref("messVotes/"+value);
  voteRef.transaction(c=>(c||0)+1,function(e,committed,snap){
    const votes=snap.val();
    if(votes>=MESS_THRESHOLD){
      db.ref("messStatus").set({status:value,timestamp:Date.now()});
      db.ref("messVotes").remove();
    }
  });
  closeModal();
}

db.ref("messStatus").on("value",snap=>{
  if(!snap.val()) return;
  document.getElementById("messStatus").innerText=snap.val().status;
});

db.ref("messVotes").on("value",snap=>{
  let total=0;
  snap.forEach(c=>total+=c.val());
  document.getElementById("messVotes").innerText=
  total>0?"Votes: "+total+"/"+MESS_THRESHOLD:"";
});

// ---------- GYM ----------

function openGym(){
  document.getElementById("modalContent").innerHTML=
  "<span class='close' onclick='closeModal()'>‚úï</span>"+
  "<h3>Gym Crowd</h3>"+
  "<button onclick=\"updateGym('0-3')\">0-3</button>"+
  "<button onclick=\"updateGym('3-5')\">3-5</button>"+
  "<button onclick=\"updateGym('5+')\">5+</button>";
  document.getElementById("modal").style.display="flex";
}

function updateGym(val){
  db.ref("gym").set({status:val,timestamp:Date.now()});
  closeModal();
}

db.ref("gym").on("value",snap=>{
  if(!snap.val()) return;
  document.getElementById("gymStatus").innerText=snap.val().status;
});

// ---------- SIMPLE OPEN/CLOSE ----------

function openSimple(place){
  document.getElementById("modalContent").innerHTML=
  "<span class='close' onclick='closeModal()'>‚úï</span>"+
  "<h3>"+place+"</h3>"+
  "<button onclick=\"updateSimple('"+place+"','Open')\">Open</button>"+
  "<button onclick=\"updateSimple('"+place+"','Closed')\">Closed</button>";
  document.getElementById("modal").style.display="flex";
}

function updateSimple(place,val){
  db.ref(place).set({status:val,timestamp:Date.now()});
  closeModal();
}

["nescafe","nandini"].forEach(p=>{
  db.ref(p).on("value",snap=>{
    if(!snap.val()) return;
    document.getElementById(p+"Status").innerText=snap.val().status;
  });
});

// ---------- BADMINTON ----------

function openBadminton(){
  document.getElementById("modalContent").innerHTML=
  "<span class='close' onclick='closeModal()'>‚úï</span>"+
  "<h3>Badminton Courts Available</h3>"+
  "<input id='courtVal' type='number' min='0' max='4' style='width:100%;padding:10px;margin-top:8px;'>"+
  "<button onclick='voteBadminton()'>Submit</button>";
  document.getElementById("modal").style.display="flex";
}

function voteBadminton(){
  const val=document.getElementById("courtVal").value;
  if(!val) return;
  const voteRef=db.ref("badmintonVotes/"+val);
  voteRef.transaction(c=>(c||0)+1,function(e,committed,snap){
    const votes=snap.val();
    if(votes>=BADMINTON_THRESHOLD){
      db.ref("badminton").set({count:val,timestamp:Date.now()});
      db.ref("badmintonVotes").remove();
    }
  });
  closeModal();
}

db.ref("badminton").on("value",snap=>{
  if(!snap.val()) return;
  document.getElementById("badmintonStatus").innerText=
  snap.val().count+" courts available";
});

db.ref("badmintonVotes").on("value",snap=>{
  let total=0;
  snap.forEach(c=>total+=c.val());
  document.getElementById("badmintonVotes").innerText=
  total>0?"Votes: "+total+"/"+BADMINTON_THRESHOLD:"";
});

// ---------- MODAL ----------

function closeModal(){
  document.getElementById("modal").style.display="none";
}

</script>
</body>
</html>
